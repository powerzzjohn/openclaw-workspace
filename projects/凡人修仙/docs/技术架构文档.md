# 凡人修仙 - 技术架构文档

**版本**: v1.0  
**日期**: 2026-02-13  
**技术栈**: React 18 + TypeScript + TailwindCSS + Node.js/Express + SQLite + Prisma + Kimi k2.5

---

## 1. 项目架构概览

```
凡人修仙/
├── frontend/           # React 前端应用
│   ├── my-app/        # Vite + React + TypeScript
│   └── ...
├── backend/           # Node.js/Express 后端服务
│   ├── src/
│   │   ├── routes/      # API 路由定义
│   │   ├── controllers/ # 请求控制器
│   │   ├── services/    # 业务逻辑层
│   │   ├── models/      # 数据模型（Prisma Client）
│   │   ├── middleware/  # 中间件（认证、错误处理等）
│   │   ├── utils/       # 工具函数
│   │   └── config/      # 配置文件
│   ├── prisma/
│   │   └── schema.prisma # 数据库Schema定义
│   └── package.json
├── shared/            # 共享类型定义和常量
└── docs/              # 项目文档
```

---

## 2. 技术选型说明

### 2.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.x | UI 框架 |
| TypeScript | 5.x | 类型安全 |
| Vite | 6.x | 构建工具 |
| TailwindCSS | 3.x | 样式框架 |
| Framer Motion | 11.x | 动画效果 |
| Zustand | 4.x | 状态管理 |
| Lucide React | 0.x | 图标库 |
| Axios | 1.x | HTTP 请求 |

### 2.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 18+ | 运行环境 |
| Express | 4.x | Web 框架 |
| TypeScript | 5.x | 类型安全 |
| Prisma | 5.x | ORM 数据库操作 |
| SQLite | 3.x | 数据库 |
| bcryptjs | 2.x | 密码加密 |
| jsonwebtoken | 9.x | JWT 认证 |
| cors | 2.x | 跨域处理 |

### 2.3 AI 集成

| 服务 | 用途 |
|------|------|
| Kimi k2.5 (Moonshot) | AI NPC 对话、每日总结生成 |

### 2.4 外部 API

| 服务 | 用途 |
|------|------|
| 高德地图 API | 地理定位、逆地理编码 |
| 和风天气 API | 实时天气数据 |
| 天文计算库 | 月相计算 |

---

## 3. 数据库设计

### 3.1 数据库选型：SQLite

**选择理由：**
- 轻量级，无需单独部署数据库服务
- 单文件存储，便于备份和迁移
- 足以支撑 MVP 阶段的并发需求
- 开发成本低，后期可平滑迁移至 PostgreSQL

### 3.2 核心数据表

#### users（用户表）
```sql
id, email, password_hash, dao_name, created_at, last_login_at
```

#### cultivations（修炼主表）
```sql
id, user_id, current_exp, total_exp, realm, realm_name,
total_days, streak_days, today_minutes, is_cultivating,
cultivate_start_at, last_cultivate_at
```

#### bazi（八字命格表）
```sql
id, user_id, birth_year/month/day/hour/minute,
year/month/day/hour_stem/branch/element,
metal/wood/water/fire/earth_count,
root_type, root_name, primary_element, root_bonus
```

#### cultivate_logs（修炼记录表）
```sql
id, user_id, start_time, end_time, duration, exp_gained,
bonus_applied, weather, temperature, city,
wu_yun, liu_qi, zi_wu_meridian, moon_phase
```

更多表结构详见：`backend/prisma/schema.prisma`

---

## 4. API 架构

### 4.1 RESTful API 设计规范

```
Base URL: /api/v1

认证相关:
POST   /auth/register          # 用户注册
POST   /auth/login             # 用户登录
POST   /auth/refresh           # 刷新 Token

用户相关:
GET    /user/profile           # 获取用户信息
PUT    /user/dao-name          # 修改道号

命格相关:
POST   /bazi/calculate         # 计算八字命格
GET    /bazi/profile           # 获取命格信息

修炼相关:
POST   /cultivate/start        # 开始修炼
POST   /cultivate/stop         # 停止修炼
GET    /cultivate/status       # 获取修炼状态
GET    /cultivate/progress     # 获取境界进度
GET    /cultivate/logs         # 获取修炼历史

天时相关:
GET    /tianshi/current        # 获取当前天时数据
GET    /tianshi/bonus          # 计算修炼加成

AI 对话:
POST   /chat/send              # 发送消息给 NPC
GET    /chat/history           # 获取对话历史
DELETE /chat/clear             # 清空对话

每日总结:
GET    /summary/today          # 获取今日总结
GET    /summary/history        # 获取历史总结

资源相关:
GET    /resources              # 获取资源信息
```

### 4.2 认证机制

**JWT Token 认证**
```
Access Token:  有效期 15 分钟，存储在内存
Refresh Token: 有效期 7 天，存储在 httpOnly Cookie
```

---

## 5. 核心算法模块

### 5.1 八字计算模块 (`utils/bazi.ts`)

```typescript
// 核心功能
- calculateBazi(birthData)     // 计算四柱八字
- determineSpiritualRoot(bazi) // 判定灵根类型
- getYearPillar(year)          // 年柱计算
- getMonthPillar(year, month, day, hour)  // 月柱计算
- getDayPillar(year, month, day)          // 日柱计算
- getHourPillar(dayStem, hour)            // 时柱计算
```

### 5.2 天时计算模块 (`utils/tianshi.ts`)

```typescript
// 核心功能
- getCurrentWeather(lat, lon)   // 获取实时天气
- calculateWuYunLiuQi(date)     // 计算五运六气
- getZiWuLiuZhu(hour)           // 子午流注
- calculateMoonPhase(date)      // 计算月相
- calculateCultivationBonus(...) // 综合加成计算
```

### 5.3 修炼计算模块 (`utils/cultivation.ts`)

```typescript
// 核心功能
- calculateExp(minutes, bonus)  // 计算经验值
- checkRealmUpgrade(currentExp) // 检查境界突破
- getRealmConfig(level)         // 获取境界配置
```

---

## 6. 前端架构

### 6.1 目录结构

```
frontend/my-app/src/
├── components/           # 组件
│   ├── common/          # 通用组件（Button, Card, Modal等）
│   ├── cultivation/     # 修炼相关组件
│   ├── bazi/            # 命格相关组件
│   ├── chat/            # 对话组件
│   └── layout/          # 布局组件
├── pages/               # 页面
│   ├── Home.tsx
│   ├── Login.tsx
│   ├── Register.tsx
│   ├── Bazi.tsx
│   ├── Profile.tsx
│   └── Chat.tsx
├── hooks/               # 自定义 Hooks
│   ├── useAuth.ts
│   ├── useCultivation.ts
│   └── useChat.ts
├── stores/              # Zustand 状态管理
│   ├── authStore.ts
│   ├── cultivationStore.ts
│   └── chatStore.ts
├── api/                 # API 封装
│   ├── client.ts        # Axios 实例
│   ├── auth.ts
│   ├── user.ts
│   ├── cultivate.ts
│   └── chat.ts
├── utils/               # 工具函数
│   ├── bazi.ts
│   ├── format.ts
│   └── constants.ts
└── types/               # TypeScript 类型定义
    ├── user.ts
    ├── cultivation.ts
    └── chat.ts
```

### 6.2 状态管理策略

使用 Zustand 进行状态管理：

```typescript
// stores/authStore.ts
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  login: (email: string, password: string) => Promise<void>;
  logout: () => void;
}

// stores/cultivationStore.ts
interface CultivationState {
  isCultivating: boolean;
  startTime: Date | null;
  elapsedTime: number;
  currentRealm: Realm;
  startCultivation: () => Promise<void>;
  stopCultivation: () => Promise<void>;
}
```

### 6.3 路由设计

```typescript
// App.tsx 路由配置
<Routes>
  <Route path="/login" element={<Login />} />
  <Route path="/register" element={<Register />} />
  <Route path="/bazi" element={<Bazi />} />  {/* 命格测算（无需登录） */}
  
  <Route element={<ProtectedRoute />}>
    <Route path="/" element={<Home />} />
    <Route path="/profile" element={<Profile />} />
    <Route path="/chat" element={<Chat />} />
    <Route path="/summary" element={<DailySummary />} />
  </Route>
</Routes>
```

---

## 7. AI 集成架构

### 7.1 NPC 对话系统

```typescript
// services/chatService.ts
class ChatService {
  async sendMessage(userId: string, message: string) {
    // 1. 获取用户上下文
    const context = await this.getUserContext(userId);
    
    // 2. 构建系统 Prompt
    const systemPrompt = this.buildSystemPrompt(context);
    
    // 3. 调用 Kimi API
    const response = await this.callKimiAPI(systemPrompt, message);
    
    // 4. 保存对话记录
    await this.saveMessage(userId, 'npc', response);
    
    return response;
  }
}
```

### 7.2 每日总结生成

```typescript
// services/summaryService.ts
class SummaryService {
  async generateDailySummary(userId: string) {
    // 1. 获取今日修炼数据
    const stats = await this.getTodayStats(userId);
    
    // 2. 构建 Prompt（融入《金丹工程》思想）
    const prompt = this.buildSummaryPrompt(stats);
    
    // 3. 调用 Kimi API 生成总结
    const summary = await this.callKimiAPI(prompt);
    
    // 4. 解析并保存总结
    return await this.saveSummary(userId, summary);
  }
}
```

---

## 8. 安全策略

### 8.1 认证安全
- 密码使用 bcryptjs 加密存储（salt rounds: 12）
- JWT Token 设置合理过期时间
- Refresh Token 使用 httpOnly Cookie
- 登录失败次数限制（防止暴力破解）

### 8.2 输入安全
- 所有用户输入做 XSS 过滤
- SQL 注入防护（使用 Prisma ORM）
- 请求参数校验（使用 Zod/Joi）

### 8.3 API 安全
- CORS 白名单配置
- 请求频率限制（Rate Limiting）
- 敏感操作日志记录

---

## 9. 部署架构

### 9.1 开发环境

```bash
# 前端
npm run dev          # Vite dev server (port 5173)

# 后端
npm run dev          # nodemon + ts-node (port 3001)

# 数据库
npx prisma studio    # Prisma GUI (port 5555)
```

### 9.2 生产部署

**推荐方案：Vercel + Railway**

```
Frontend (Vercel)
    │
    ▼
Backend API (Railway)
    │
    ▼
SQLite Database (Railway Volume)
```

**备选方案：单服务器部署**
```
Server
├── Nginx (反向代理 + SSL)
├── Frontend (静态文件)
├── Backend (Node.js + PM2)
└── SQLite Database
```

---

## 10. 开发规范

### 10.1 代码规范
- ESLint + Prettier 统一代码风格
- TypeScript 严格模式
- 组件文件使用 PascalCase
- 工具函数使用 camelCase

### 10.2 Git 规范
```
分支命名:
  - main          # 主分支
  - develop       # 开发分支
  - feature/xxx   # 功能分支
  - fix/xxx       # 修复分支

提交规范:
  - feat: 新功能
  - fix: 修复
  - docs: 文档
  - style: 格式
  - refactor: 重构
  - test: 测试
```

### 10.3 注释规范
```typescript
/**
 * 计算八字四柱
 * @param birthYear 出生年份
 * @param birthMonth 出生月份
 * @param birthDay 出生日期
 * @param birthHour 出生时辰（0-23）
 * @returns BaziResult 八字计算结果
 */
function calculateBazi(
  birthYear: number,
  birthMonth: number,
  birthDay: number,
  birthHour: number
): BaziResult {
  // 实现...
}
```

---

## 11. 性能优化策略

### 11.1 前端优化
- 使用 React.memo 避免不必要渲染
- 图片懒加载
- 路由懒加载（React.lazy）
- 使用 Web Worker 处理八字计算

### 11.2 后端优化
- 数据库查询优化（添加索引）
- API 响应缓存（Redis，可选）
- 静态资源 CDN 加速

---

## 12. 监控与日志

### 12.1 日志规范
```typescript
// 使用 Winston 或 Pino
logger.info('用户开始修炼', { userId, timestamp });
logger.error('修炼计算失败', { error, userId });
```

### 12.2 错误处理
```typescript
// 统一错误响应格式
{
  "success": false,
  "error": {
    "code": "CULTIVATION_ERROR",
    "message": "修炼数据异常",
    "details": "..."
  }
}
```

---

## 13. 后续扩展计划

### 13.1 技术债务
- [ ] 添加单元测试（Jest + React Testing Library）
- [ ] 添加 E2E 测试（Playwright）
- [ ] 数据库迁移至 PostgreSQL（用户量增长后）

### 13.2 功能扩展
- [ ] 多人修炼房间
- [ ] 排行榜系统
- [ ] 社交功能（道友互动）
- [ ] 更多 AI NPC 角色
- [ ] 移动端 App（React Native）

---

**文档维护**: 修仙开发助手  
**最后更新**: 2026-02-13
