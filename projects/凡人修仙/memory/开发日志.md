# 凡人修仙 - 开发日志

## 2026-02-13 - Phase 1 完成：用户认证模块

### 已完成工作

#### 1. 文件创建
- ✅ `src/utils/jwt.ts` - JWT 工具函数（生成、验证、提取）
- ✅ `src/middleware/auth.ts` - JWT 认证中间件（强制/可选）
- ✅ `src/services/authService.ts` - 认证业务逻辑
- ✅ `src/controllers/authController.ts` - HTTP 请求处理
- ✅ `src/routes/authRoutes.ts` - 路由定义

#### 2. API 实现
- ✅ `POST /api/v1/auth/register` - 用户注册
  - 参数校验（邮箱格式、密码强度、道号格式）
  - bcrypt 加密（saltRounds: 10）
  - 自动初始化用户资源和修炼数据
  
- ✅ `POST /api/v1/auth/login` - 用户登录
  - JWT Token 生成（有效期7天）
  - 更新最后登录时间
  
- ✅ `GET /api/v1/auth/me` - 获取当前用户
  - 需 Bearer Token 认证

#### 3. 安全机制
- 密码加密：bcryptjs，saltRounds: 10
- JWT 有效期：7天
- 邮箱唯一性校验
- 道号唯一性校验
- 密码强度：最少8位，含字母+数字

#### 4. 错误处理
| 场景 | HTTP状态码 | 错误码 |
|------|-----------|--------|
| 邮箱已存在 | 409 | CONFLICT |
| 道号已存在 | 409 | CONFLICT |
| 密码错误 | 401 | UNAUTHORIZED |
| 用户不存在 | 404 | NOT_FOUND |
| 参数验证失败 | 400 | BAD_REQUEST |
| 未授权 | 401 | UNAUTHORIZED |

#### 5. 测试验证
```bash
# 注册
POST /api/v1/auth/register
{"email": "xiuxian@test.com", "password": "XiuXian123", "daoName": "青云子"}
# ✅ 返回用户信息和 JWT Token

# 登录
POST /api/v1/auth/login
{"email": "xiuxian@test.com", "password": "XiuXian123"}
# ✅ 返回用户信息和 JWT Token

# 获取当前用户
GET /api/v1/auth/me
Authorization: Bearer <token>
# ✅ 返回用户信息

# 错误场景测试 ✅
- 邮箱已存在 (409)
- 道号已存在 (409)
- 密码错误 (401)
- 用户不存在 (404)
- 密码强度不足 (400)
```

### 技术债务
- 修复了 @prisma/client 类型定义缺失问题（手动添加 default.d.ts）

### 下一步
- Phase 2：八字命格计算 API
