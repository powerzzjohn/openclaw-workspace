generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  daoName      String    @unique @map("dao_name")
  createdAt    DateTime  @default(now()) @map("created_at")
  lastLoginAt  DateTime? @map("last_login_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // 关联
  cultivation    Cultivation?
  bazi           Bazi?
  resources      Resources?
  chatMessages   ChatMessage[]
  dailySummaries DailySummary[]
  cultivateLogs  CultivateLog[]

  @@map("users")
}

// 修炼主表
model Cultivation {
  id               String    @id @default(uuid())
  userId           String    @unique @map("user_id")
  currentExp       Int       @default(0) @map("current_exp")
  totalExp         Int       @default(0) @map("total_exp")
  realm            Int       @default(1)
  realmName        String    @default("炼气") @map("realm_name")
  totalDays        Int       @default(0) @map("total_days")
  streakDays       Int       @default(0) @map("streak_days")
  todayMinutes     Int       @default(0) @map("today_minutes")
  isCultivating    Boolean   @default(false) @map("is_cultivating")
  cultivateStartAt DateTime? @map("cultivate_start_at")
  lastCultivateAt  DateTime? @map("last_cultivate_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("cultivations")
}

// 八字命格表
model Bazi {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // 出生信息
  birthYear   Int    @map("birth_year")
  birthMonth  Int    @map("birth_month")
  birthDay    Int    @map("birth_day")
  birthHour   Int    @map("birth_hour")
  birthMinute Int    @default(0) @map("birth_minute")
  timezone    String @default("Asia/Shanghai")

  // 四柱 - 年柱
  yearStem    String @map("year_stem")
  yearBranch  String @map("year_branch")
  yearElement String @map("year_element")

  // 四柱 - 月柱
  monthStem    String @map("month_stem")
  monthBranch  String @map("month_branch")
  monthElement String @map("month_element")

  // 四柱 - 日柱
  dayStem    String @map("day_stem")
  dayBranch  String @map("day_branch")
  dayElement String @map("day_element")

  // 四柱 - 时柱
  hourStem    String @map("hour_stem")
  hourBranch  String @map("hour_branch")
  hourElement String @map("hour_element")

  // 五行统计
  metalCount Int @default(0) @map("metal_count")
  woodCount  Int @default(0) @map("wood_count")
  waterCount Int @default(0) @map("water_count")
  fireCount  Int @default(0) @map("fire_count")
  earthCount Int @default(0) @map("earth_count")

  // 灵根信息
  rootType         String  @map("root_type") // tian/double/triple/four/five/variant
  rootName         String  @map("root_name")
  primaryElement   String  @map("primary_element")
  secondaryElement String? @map("secondary_element")
  variantType      String? @map("variant_type")
  rootBonus        Float   @map("root_bonus")
  rootDescription  String  @map("root_description")

  calculatedAt DateTime @default(now()) @map("calculated_at")

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("bazi")
}

// 资源表
model Resources {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  spiritStones Int      @default(0) @map("spirit_stones")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  treasures Treasure[]

  @@map("resources")
}

// 宝物表
model Treasure {
  id          String   @id @default(uuid())
  resourcesId String   @map("resources_id")
  name        String
  description String?
  rarity      String   @default("common") // common/rare/epic/legendary
  effect      String?
  acquiredAt  DateTime @default(now()) @map("acquired_at")

  // 关联
  resources Resources @relation(fields: [resourcesId], references: [id], onDelete: Cascade)

  @@map("treasures")
}

// 修炼记录表
model CultivateLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  startTime    DateTime @map("start_time")
  endTime      DateTime @map("end_time")
  duration     Int // 修炼时长（分钟）
  expGained    Int      @map("exp_gained")
  bonusApplied Float    @map("bonus_applied")

  // 天时数据
  weather      String?
  temperature  Float?
  city         String?
  wuYun        String? @map("wu_yun")
  liuQi        String? @map("liu_qi")
  ziWuMeridian String? @map("zi_wu_meridian")
  moonPhase    String? @map("moon_phase")

  createdAt DateTime @default(now()) @map("created_at")

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("cultivate_logs")
}

// 聊天记录表
model ChatMessage {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  role      String // 'user' or 'npc'
  content   String
  metadata  String? // JSON格式存储额外信息
  createdAt DateTime @default(now()) @map("created_at")

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("chat_messages")
}

// 每日总结表
model DailySummary {
  id     String   @id @default(uuid())
  userId String   @map("user_id")
  date   DateTime

  // 基础数据
  todayMinutes Int   @map("today_minutes")
  expGained    Int   @map("exp_gained")
  bonusApplied Float @map("bonus_applied")

  // 总结内容
  greeting          String
  cultivationReview String @map("cultivation_review")
  insight           String
  wisdom            String
  suggestion        String
  goldenQuote       String @map("golden_quote")

  // 元数据
  generationPrompt String   @map("generation_prompt")
  modelUsed        String   @map("model_used")
  generatedAt      DateTime @map("generated_at")

  // 用户反馈
  userRating   Int?    @map("user_rating")
  userFeedback String? @map("user_feedback")

  // 关联
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("daily_summaries")
}

// 箴言库表
model Proverb {
  id        String   @id @default(uuid())
  text      String
  source    String
  element   String? // 五行关联：金木水火土
  theme     String? // 主题：心境、修炼、悟道等
  createdAt DateTime @default(now()) @map("created_at")

  @@map("proverbs")
}

// 用户箴言记录表
model UserProverb {
  userId         String    @map("user_id")
  date           DateTime
  proverbId      String    @map("proverb_id")
  isComprehended Boolean   @default(false) @map("is_comprehended")
  comprehendedAt DateTime? @map("comprehended_at")

  @@id([userId, date])
  @@map("user_proverbs")
}

// 境界配置表
model RealmConfig {
  id          String  @id @default(uuid())
  level       Int     @unique
  name        String
  icon        String
  maxExp      Int     @map("max_exp")
  description String?

  @@map("realm_configs")
}
