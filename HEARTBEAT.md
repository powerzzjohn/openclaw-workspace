# HEARTBEAT.md

## 定期检查任务

### 1. 模型用量监控检查
检查是否有余额不足的警报：
- 查看 `~/.openclaw/workspace/alerts/` 目录
- 如有警报文件，向用户发送提醒
- 运行监控脚本更新余额信息

```bash
# 手动运行监控
~/.openclaw/workspace/scripts/monitor_models.sh
```

### 2. 检查警报文件
```
~/.openclaw/workspace/alerts/moonshot_alert.txt  # Moonshot余额不足
```

### 3. 飞书通道健康检查
检查飞书 WebSocket 连接状态：
- 查看网关日志中是否有飞书连接错误
- 检查最近是否有 `getaddrinfo ENOTFOUND open.feishu.cn` 错误
- 检查是否有 `feishu: dispatching to agent` 消息（表示正常接收消息）

**自动修复逻辑：**
如果检测到飞书连接异常（长时间无消息且日志有错误）：
```bash
# 自动重启网关恢复连接
openclaw gateway restart
```

**注意：** 飞书服务器会缓存未送达消息，重启后消息不会丢失。

### 4. 定时任务
- 每小时自动运行一次监控脚本
- 每天上午8点生成用量报告
- 每2小时检查一次飞书通道状态

---

## 🛡️ 防额度耗尽机制（2026-02-14 更新）

### 熔断策略
当同一警报持续超过 **1小时** 时：
- **停止高频详细报告**
- **改为每小时摘要报告一次**
- 响应格式简化为：`⚠️ [警报名] 持续X小时`

### 夜间模式
- **23:00 - 08:00**：降低检查频率，非紧急情况不发送详细报告
- 紧急情况：余额耗尽、系统崩溃等才立即报告

### 响应优化
- **重复警报合并**：同一警报在30分钟内只报告一次变化
- **简洁格式**：使用 `⚠️ 警报名（持续X小时）` 代替详细描述
- **批量处理**：多个相关警报合并为一条消息

### 熔断触发条件
```
同一警报持续时间 > 1小时
└── 自动启用简化报告模式
    └── 每小时报告一次：⚠️ [警报名] 持续X小时
```

---

## 警报优先级

| 优先级 | 警报类型 | 响应方式 |
|--------|----------|----------|
| 🔴 **紧急** | 系统崩溃、所有模型不可用 | 立即报告，详细说明 |
| 🟡 **重要** | 单一模型余额不足、连接断开 | 首次详细报告，后续简化 |
| 🟢 **普通** | 低余额预警（>¥10）| 每小时检查一次 |

---

## 如果没有待处理警报，回复：HEARTBEAT_OK
